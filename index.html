<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coffee Counter ☕</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Retro mono font -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
  <!-- Supabase & Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    :root {
      /* coffee palette */
      --coffee-dark: #4e342e;
      --coffee-mid:  #6f4e37;
      --coffee-light:#d7ccc8;
      --coffee-foam: #fff5ef;
    }
    body {
      font-family: 'IBM Plex Mono', monospace;
      background-color: var(--coffee-foam);
      color: var(--coffee-dark);
    }
    .paper {
      background-image: radial-gradient(circle, rgba(0,0,0,0.04) 1px, transparent 1px);
      background-size: 4px 4px;
    }
    .btn-type.active {
      @apply bg-[var(--coffee-dark)] text-white;
    }
    /* chart container ensures no overflow */
    .chart-card {
      @apply bg-white p-4 rounded-2xl shadow-lg border flex flex-col;
      height: 320px; /* fixed height for uniformity */
    }
    .chart-card canvas {
      flex: 1 1 auto;
    }
  </style>
</head>
<body class="paper min-h-screen p-6 flex flex-col gap-8">
  <!-- HEADER -->
  <header>
    <h1 class="text-4xl md:text-5xl font-semibold tracking-tight flex items-center gap-3">
      <span>☕</span> Coffee Counter <span class="hidden sm:inline">— Michele &amp; Martina</span>
    </h1>
    <p class="text-sm text-coffee-mid mt-1">Shared caffeine tracker — Supabase powered.</p>
  </header>

  <!-- NEW ENTRY FORM -->
  <section id="add" class="flex flex-wrap items-center gap-3">
    <label class="text-sm">Chi?</label>
    <select id="user" class="border rounded-lg px-2 py-1 shadow-sm bg-white">
      <option>Michele</option>
      <option>Martina</option>
    </select>

    <label class="text-sm ml-4">Tipo:</label>
    <div id="typeButtons" class="flex gap-1">
      <button class="btn-type border px-2 py-1 rounded-lg shadow-sm" data-type="single">Single</button>
      <button class="btn-type border px-2 py-1 rounded-lg shadow-sm" data-type="moka4">Moka 4</button>
      <button class="btn-type border px-2 py-1 rounded-lg shadow-sm" data-type="americano">Americano</button>
      <button class="btn-type border px-2 py-1 rounded-lg shadow-sm" data-type="decaf">Decaf</button>
    </div>

    <button id="addBtn" class="bg-[var(--coffee-dark)] text-white px-4 py-1.5 rounded-lg shadow-md hover:bg-[#3b261f] transition">+ Aggiungi</button>
  </section>

  <!-- QUICK INFO -->
  <section id="quickInfo" class="flex flex-col sm:flex-row gap-6">
    <div id="lastCoffeeCard" class="flex-1 p-4 rounded-2xl shadow-lg bg-white border text-center"></div>
  </section>

  <!-- STAT CARDS -->
  <section>
    <h2 class="text-2xl mb-4">Statistiche</h2>
    <div id="statsGrid" class="grid grid-cols-1 sm:grid-cols-3 gap-6"></div>
  </section>

  <!-- CHARTS -->
  <section>
    <h2 class="text-2xl mb-4 mt-8">Grafici</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="chart-card"><canvas id="dailyChart"></canvas></div>
      <div class="chart-card"><canvas id="typeChart"></canvas></div>
    </div>
  </section>

  <!-- HISTORY TABLE -->
  <section id="history" class="flex-1 overflow-x-auto mt-8">
    <h2 class="text-2xl mb-4">Storico</h2>
    <table class="min-w-full text-sm">
      <thead>
        <tr class="border-b border-gray-300">
          <th class="p-2 text-left font-medium">Quando</th>
          <th class="p-2 text-left font-medium">Chi</th>
          <th class="p-2 text-left font-medium">Tipo</th>
          <th class="p-2 text-left font-medium">Azioni</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </section>

<script type="module">
/* ========= CONFIG ========= */
const SUPABASE_URL = 'https://hcnlrldthpjzeehxilwg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjbmxybGR0aHBqemVlaHhpbHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMzg0MzYsImV4cCI6MjA2NzgxNDQzNn0.XaD7iXpsin7J22_HBpGJUs5IiPTpYLQupo7cYuYIN2A';
const TABLE = 'coffee_entries';
/*──────────────────────── INIT ──────────────────────────*/
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/*──────────────────────── STATE ─────────────────────────*/
let entries      = [];          // dati in RAM ordinati (più recente in testa)
let activeType   = 'single';    // default tipo selezionato
let dailyChart, typeChart;      // istanze Chart.js

const DAY = 86_400_000;
const today      = () => new Date(new Date().setHours(0,0,0,0));
const startOfDay = d => new Date(d.setHours(0,0,0,0));
const startOfYear= d => new Date(d.getFullYear(), 0, 1);
const since      = date => entries.filter(e => e.time >= date);

/*─────────────────── CRUD + REALTIME ───────────────────*/
async function hydrate() {
  const { data, error } = await supabase.from(TABLE)
    .select('*')
    .order('time', { ascending: false });
  if (error) return console.error(error);

  entries = data.map(e => ({ ...e, time: new Date(e.time) }));
  renderAll();
}

/* add row */
async function addEntry(user, type) {
  const optimistic = { id: crypto.randomUUID(), user, type, time: new Date(), _optimistic:true };
  entries.unshift(optimistic);
  renderAll();

  const { data, error } = await supabase
    .from(TABLE)
    .insert({ user, type })
    .select()
    .single();

  if (error) { console.error(error); hydrate(); }   // rollback
}

/* delete row */
async function deleteEntry(id) {
  // optimistic
  entries = entries.filter(e => e.id !== id);
  renderAll();

  const { error } = await supabase.from(TABLE).delete().eq('id', id);
  if (error) { console.error(error); hydrate(); }
}

/* realtime subscription */
supabase.channel('coffee-rt')
  .on('postgres_changes', { event: '*', schema: 'public', table: TABLE }, payload => {
    // ricompatta sempre lo stato con i dati DB “ufficiali”
    hydrate();
  })
  .subscribe();

/*────────────────────── RENDERERS ───────────────────────*/
function renderLastCoffee() {
  const card = document.getElementById('lastCoffeeCard');
  if (!entries.length) {
    card.innerHTML = '<span class="text-gray-500">Nessun caffè registrato.</span>';
    return;
  }
  const { type, user, time } = entries[0];
  card.innerHTML = `
    <h3 class="text-lg mb-1 uppercase tracking-wide text-[var(--coffee-mid)]">Ultimo caffè</h3>
    <div class="text-3xl font-bold mb-1">${type}</div>
    <div class="text-sm text-gray-600">${user} — ${time.toLocaleString('it-IT')}</div>
  `;
}

function renderStats() {
  const grid = document.getElementById('statsGrid');
  grid.innerHTML = '';

  const now = new Date();
  const blocks = [
    { label: 'Oggi',        from: startOfDay(new Date(now)) },
    { label: 'Ultimi 7 gg', from: new Date(now - 7*DAY) },
    { label: 'YTD',         from: startOfYear(new Date(now)) },
  ];

  blocks.forEach(({ label, from }) => {
    const subset = since(from);
    const counts = subset.reduce((acc,{user}) => (acc[user]=(acc[user]||0)+1, acc), {});
    const total  = subset.length;

    grid.insertAdjacentHTML('beforeend', `
      <div class="p-4 rounded-2xl shadow-lg bg-white border hover:shadow-xl transition">
        <h3 class="text-lg mb-2 uppercase tracking-wide text-[var(--coffee-mid)]">${label}</h3>
        <div class="text-4xl font-bold mb-1">${total}</div>
        <div class="text-xs text-gray-500">
            Michele: ${counts.Michele||0}<br>
            Martina: ${counts.Martina||0}
        </div>
      </div>
    `);
  });
}

function renderCharts() {
  /* distruggi istanze vecchie per evitare overlay */
  dailyChart?.destroy();  typeChart?.destroy();

  /* === DAILY AREA (30gg) === */
  const ctxDaily = document.getElementById('dailyChart').getContext('2d');
  const base = today();
  const labels = Array.from({length:30},(_,i)=>{
    const d = new Date(base - (29-i)*DAY);
    return d.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit'});
  });
  const counts = labels.map((_,i)=>{
    const s = new Date(base - (29-i)*DAY);
    const e = new Date(s.getTime()+DAY);
    return entries.filter(e1 => e1.time>=s && e1.time<e).length;
  });

  const grad = ctxDaily.createLinearGradient(0,0,0,300);
  grad.addColorStop(0,'rgba(111,78,55,0.45)');
  grad.addColorStop(1,'rgba(255,245,239,0.05)');

  dailyChart = new Chart(ctxDaily,{
    type:'line',
    data:{labels,
      datasets:[{data:counts,fill:true,backgroundColor:grad,
        borderColor:'var(--coffee-mid)',pointRadius:3,
        pointBackgroundColor:'var(--coffee-dark)',tension:0.35}]},
    options:{responsive:true,maintainAspectRatio:false,
      scales:{x:{grid:{display:false}},y:{beginAtZero:true,
        grid:{color:'rgba(0,0,0,0.05)'}}},
      plugins:{legend:{display:false},
               tooltip:{backgroundColor:'var(--coffee-dark)',
                        titleColor:'#fff',bodyColor:'#fff'}}}
  });

  /* === TYPE DOUGHNUT (ultimi 7gg) === */
  const ctxType = document.getElementById('typeChart').getContext('2d');
  const last7   = since(new Date(Date.now()-7*DAY));
  const tCounts = last7.reduce((o,{type})=>(o[type]=(o[type]||0)+1,o),{});

  typeChart = new Chart(ctxType,{
    type:'doughnut',
    data:{labels:Object.keys(tCounts),
          datasets:[{data:Object.values(tCounts),
                     backgroundColor:['#4e342e','#6f4e37','#8d6e63','#d7ccc8'],
                     hoverOffset:6}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'bottom',
                       labels:{color:'var(--coffee-dark)'}},
               tooltip:{backgroundColor:'var(--coffee-dark)',
                        titleColor:'#fff',bodyColor:'#fff'}}}
  });
}

function renderHistory() {
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = '';

  entries.forEach(({id,user,type,time,_optimistic})=>{
    const tr = document.createElement('tr');
    tr.className = 'border-b border-gray-300';

    tr.innerHTML = `
      <td class="p-2">${time.toLocaleString('it-IT')}</td>
      <td class="p-2">${user}</td>
      <td class="p-2 capitalize">${type}</td>
      <td class="p-2">
        <button ${_optimistic?'disabled':''}
          class="text-[var(--danger)] hover:underline" data-id="${id}">❌</button>
      </td>`;
    tbody.appendChild(tr);
  });

  /* delega per click delete */
  tbody.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick = () => deleteEntry(btn.dataset.id);
  });
}

function renderAll() {
  renderLastCoffee();
  renderStats();
  renderCharts();
  renderHistory();
}

/*──────────────────────── UI HOOKS ───────────────────────*/
document.getElementById('typeButtons').addEventListener('click', e=>{
  const btn = e.target.closest('button[data-type]');
  if (!btn) return;
  activeType = btn.dataset.type;
  /* toggle bg */
  document.querySelectorAll('.btn-type').forEach(b=>b.classList.toggle('active',b===btn));
});

document.getElementById('addBtn').addEventListener('click',()=>{
  const user = document.getElementById('user').value;
  addEntry(user, activeType);
});

/*──────────────────────── BOOT ───────────────────────────*/
hydrate();   // carica dati iniziali
</script>
</body>
</html>
