<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Coffee Counter</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --coffee-dark:#4e342e;   /* espresso */
      --coffee-mid:#6f4e37;    /* moka */
      --coffee-light:#d7ccc8;  /* latte foam */
      --danger:#b71c1c;
    }
    body{font-family:'IBM Plex Mono',monospace;background:#faf9f7;}
    .chart-card{height:320px}
    .btn-type{border:1px solid var(--coffee-mid);padding:.5rem 1rem;border-radius:.5rem;margin:.125rem}
    .btn-type.active{background:var(--coffee-mid);color:#fff}
  </style>
</head>

<body class="p-4">
<div class="max-w-3xl mx-auto space-y-6">

  <!-- Controls -->
  <div class="flex flex-wrap items-center gap-3">
    <select id="user" class="border p-2 rounded grow">
      <option>Michele</option>
      <option>Martina</option>
    </select>

    <div id="typeButtons" class="flex flex-wrap">
      <button class="btn-type active" data-type="single">Single</button>
      <button class="btn-type" data-type="moka4">Moka 4</button>
      <button class="btn-type" data-type="americano">Americano</button>
      <button class="btn-type" data-type="decaf">Decaf</button>
    </div>

    <button id="addBtn" class="bg-[var(--coffee-dark)] text-white px-4 py-2 rounded hover:bg-[var(--coffee-mid)] transition">
      + Aggiungi ☕
    </button>
  </div>

  <!-- Ultimo caffè -->
  <div id="lastCoffeeCard" class="p-4 rounded-2xl border bg-white shadow"></div>

  <!-- Stats -->
  <div id="statsGrid" class="grid md:grid-cols-3 gap-4"></div>

  <!-- Charts -->
  <div class="grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-2xl border bg-white shadow chart-card">
      <h3 class="uppercase tracking-wide text-[var(--coffee-mid)] mb-2">Ultimi 30 giorni</h3>
      <canvas id="dailyChart" class="w-full h-full"></canvas>
    </div>
    <div class="p-4 rounded-2xl border bg-white shadow chart-card">
      <h3 class="uppercase tracking-wide text-[var(--coffee-mid)] mb-2">Distribuzione tipi (7 gg)</h3>
      <canvas id="typeChart" class="w-full h-full"></canvas>
    </div>
  </div>

  <!-- History -->
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="border-b-2 border-gray-400">
          <th class="p-2 text-left">Data/Ora</th>
          <th class="p-2 text-left">Utente</th>
          <th class="p-2 text-left">Tipo</th>
          <th class="p-2 text-left">Azioni</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- App -->
<script type="module">
/*──────────────────────── CONFIG ────────────────────────*/
/* ========= CONFIG (set your own) ========= */
const SUPABASE_URL = 'https://hcnlrldthpjzeehxilwg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjbmxybGR0aHBqemVlaHhpbHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMzg0MzYsImV4cCI6MjA2NzgxNDQzNn0.XaD7iXpsin7J22_HBpGJUs5IiPTpYLQupo7cYuYIN2A';
const TABLE = 'coffee_entries';
/*──────────────────────── INIT ──────────────────────────*/
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime:{ enabled:true } });
/*──────────────────────── STATE ─────────────────────────*/
let entries = [];              // array ordinato (più recente in testa)
let activeType = 'single';
let dailyChart, typeChart;

const DAY = 86_400_000;
/* helpers */
const todayZero   = () => new Date(new Date().setHours(0,0,0,0));
const startOfYear = d => new Date(d.getFullYear(),0,1);
/*─────────────────── CRUD + REALTIME ───────────────────*/
async function hydrate(){
  const { data, error } = await supabase.from(TABLE).select('*').order('time',{ascending:false});
  if(error){ console.error(error); return; }
  entries = data.map(r=>({...r, time:new Date(r.time)}));
  renderAll();
}

async function addEntry(user, type){
  const tempId = crypto.randomUUID();                           // placeholder
  entries.unshift({ id: tempId, user, type, time: new Date(), _optimistic:true });
  renderAll();

  const { data, error } = await supabase.from(TABLE).insert({ user, type }).select().single();
  if(error){ console.error(error); hydrate(); return; }
  // sostituisci placeholder con riga “vera”
  entries = entries.map(r=>r.id===tempId?({...data,time:new Date(data.time)}):r);
  renderAll();
}

async function deleteEntry(id){
  const backup = [...entries];                  // rollback se errore
  entries = entries.filter(r=>r.id!==id);
  renderAll();

  const { error } = await supabase.from(TABLE).delete().eq('id', id);
  if(error){ console.error(error); entries = backup; renderAll(); }
}

/* realtime broadcast */
supabase.channel('coffee-rt')
  .on('postgres_changes', { event:'*', schema:'public', table:TABLE }, () => hydrate())
  .subscribe();
/*────────────────────── RENDERERS ───────────────────────*/
function renderLast(){
  const card = document.getElementById('lastCoffeeCard');
  if(!entries.length){ card.innerHTML='<span class="text-gray-500">Nessun caffè registrato.</span>'; return; }
  const { user, type, time } = entries[0];
  card.innerHTML = `
    <h3 class="text-lg mb-1 uppercase tracking-wide text-[var(--coffee-mid)]">Ultimo caffè</h3>
    <div class="text-3xl font-bold mb-1">${type}</div>
    <div class="text-sm text-gray-600">${user} — ${time.toLocaleString('it-IT')}</div>
  `;
}

function renderStats(){
  const now = new Date();
  const ranges = [
    { label:'Oggi',        from: todayZero() },
    { label:'Ultimi 7 gg', from: new Date(now-DAY*7) },
    { label:'YTD',         from: startOfYear(now) }
  ];
  const grid = document.getElementById('statsGrid'); grid.innerHTML='';
  ranges.forEach(({label,from})=>{
    const subset = entries.filter(e=>e.time>=from);
    const perUser = subset.reduce((a,{user})=>(a[user]=(a[user]||0)+1,a),{});
    grid.insertAdjacentHTML('beforeend',`
      <div class="p-4 rounded-2xl shadow bg-white border hover:shadow-xl transition">
        <h3 class="text-lg mb-2 uppercase tracking-wide text-[var(--coffee-mid)]">${label}</h3>
        <div class="text-4xl font-bold mb-1">${subset.length}</div>
        <div class="text-xs text-gray-500">
          Michele: ${perUser.Michele||0}<br>
          Martina: ${perUser.Martina||0}
        </div>
      </div>
    `);
  });
}

function renderCharts(){
  dailyChart?.destroy(); typeChart?.destroy();

  /* === DAILY (per utente) === */
  const base  = todayZero();
  const labels= Array.from({length:30},(_,i)=>{
    const d = new Date(base-(29-i)*DAY);
    return d.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit'});
  });
  const users = ['Michele','Martina'];
  const colors= ['#4e342e','#8d6e63'];   // espresso / cappuccino

  const datasets = users.map((u,i)=>{
    const data = labels.map((_,idx)=>{
      const s = new Date(base-(29-idx)*DAY), e = new Date(s.getTime()+DAY);
      return entries.filter(e1=>e1.user===u && e1.time>=s && e1.time<e).length;
    });
    return { label:u, data, borderColor:colors[i], pointRadius:3, tension:.35, fill:false,
             pointBackgroundColor:colors[i] };
  });

  new Chart(document.getElementById('dailyChart'),{
    type:'line',
    data:{ labels, datasets },
    options:{ responsive:true, maintainAspectRatio:false,
      scales:{ x:{ grid:{ display:false } }, y:{ beginAtZero:true, grid:{color:'rgba(0,0,0,0.05)'} } },
      plugins:{ legend:{ position:'bottom' },
        tooltip:{ backgroundColor:'var(--coffee-dark)', titleColor:'#fff', bodyColor:'#fff' } }
    }
  });

  /* === TYPE DOUGHNUT === */
  const last7 = entries.filter(e=>e.time>=new Date(Date.now()-DAY*7));
  const tCount= last7.reduce((o,{type})=>(o[type]=(o[type]||0)+1,o),{});
  new Chart(document.getElementById('typeChart'),{
    type:'doughnut',
    data:{ labels:Object.keys(tCount),
           datasets:[{ data:Object.values(tCount),
                       backgroundColor:['#4e342e','#6f4e37','#8d6e63','#d7ccc8'], hoverOffset:6 }] },
    options:{ responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:'bottom' },
        tooltip:{ backgroundColor:'var(--coffee-dark)', titleColor:'#fff', bodyColor:'#fff' } }
    }
  });
}

function renderHistory(){
  const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
  entries.forEach(({id,user,type,time,_optimistic})=>{
    const tr=document.createElement('tr'); tr.className='border-b border-gray-300';
    tr.innerHTML=`
      <td class="p-2 whitespace-nowrap">${time.toLocaleString('it-IT')}</td>
      <td class="p-2">${user}</td>
      <td class="p-2 capitalize">${type}</td>
      <td class="p-2">
        <button class="hover:underline text-[var(--danger)]"
                data-id="${id}" ${_optimistic?'disabled':''}>❌</button>
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick = () => deleteEntry(btn.dataset.id);
  });
}

function renderAll(){ renderLast(); renderStats(); renderCharts(); renderHistory(); }
/*──────────────────────── UI HOOKS ───────────────────────*/
document.getElementById('typeButtons').addEventListener('click',e=>{
  const btn=e.target.closest('button[data-type]'); if(!btn) return;
  activeType=btn.dataset.type;
  document.querySelectorAll('.btn-type').forEach(b=>b.classList.toggle('active',b===btn));
});
document.getElementById('addBtn').onclick=()=>{
  const user=document.getElementById('user').value;
  addEntry(user,activeType);
};
/*──────────────────────── BOOT ───────────────────────────*/
hydrate();
</script>
</body>
</html>
