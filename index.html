<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coffee Counter ☕</title>
  <!-- TailwindCSS → quick CDN load -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts → retro-mono -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
  <!-- Supabase JS & Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'IBM Plex Mono', monospace;
      background-color: #fdfcf8;
      color: #1e1e1e;
    }
    .paper {
      background-image: radial-gradient(circle, rgba(0,0,0,0.04) 1px, transparent 1px);
      background-size: 4px 4px;
    }
    .btn-type.active {
      @apply bg-black text-white;
    }
  </style>
</head>
<body class="paper min-h-screen p-6 flex flex-col gap-8">
  <!-- HEADER -->
  <header>
    <h1 class="text-4xl md:text-5xl font-semibold tracking-tight flex items-center gap-3">
      <span>☕</span> Coffee Counter <span class="hidden sm:inline">— Michele &amp; Martina</span>
    </h1>
    <p class="text-sm text-gray-600 mt-1">Shared caffeine tracker — Supabase powered.</p>
  </header>

  <!-- NEW ENTRY FORM -->
  <section id="add" class="flex flex-wrap items-center gap-3">
    <label class="text-sm">Chi?</label>
    <select id="user" class="border rounded-lg px-2 py-1 shadow-sm bg-white">
      <option>Michele</option>
      <option>Martina</option>
    </select>

    <label class="text-sm ml-4">Tipo:</label>
    <div id="typeButtons" class="flex gap-1">
      <button class="btn-type border px-2 py-1 rounded-lg shadow-sm" data-type="single">Single</button>
      <button class="btn-type border px-2 py-1 rounded-lg shadow-sm" data-type="moka4">Moka 4</button>
      <button class="btn-type border px-2 py-1 rounded-lg shadow-sm" data-type="americano">Americano</button>
      <button class="btn-type border px-2 py-1 rounded-lg shadow-sm" data-type="decaf">Decaf</button>
    </div>

    <button id="addBtn" class="bg-black text-white px-4 py-1.5 rounded-lg shadow-md hover:bg-gray-800 transition">+ Aggiungi</button>
  </section>

  <!-- QUICK INFO -->
  <section id="quickInfo" class="flex flex-col sm:flex-row gap-6">
    <div id="lastCoffeeCard" class="flex-1 p-4 rounded-2xl shadow-lg bg-white border border-gray-200 text-center"></div>
  </section>

  <!-- STAT CARDS -->
  <section>
    <h2 class="text-2xl mb-4">Statistiche</h2>
    <div id="statsGrid" class="grid grid-cols-1 sm:grid-cols-3 gap-6"></div>
  </section>

  <!-- CHARTS -->
  <section>
    <h2 class="text-2xl mb-4 mt-8">Grafici</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <canvas id="dailyChart" class="bg-white rounded-2xl p-4 shadow-lg border"></canvas>
      <canvas id="typeChart" class="bg-white rounded-2xl p-4 shadow-lg border"></canvas>
    </div>
  </section>

  <!-- HISTORY TABLE -->
  <section id="history" class="flex-1 overflow-x-auto mt-8">
    <h2 class="text-2xl mb-4">Storico</h2>
    <table class="min-w-full text-sm">
      <thead>
        <tr class="border-b border-gray-300">
          <th class="p-2 text-left font-medium">Quando</th>
          <th class="p-2 text-left font-medium">Chi</th>
          <th class="p-2 text-left font-medium">Tipo</th>
          <th class="p-2 text-left font-medium">Azioni</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </section>

<script type="module">
/* ========= CONFIG (set your own) ========= */
const SUPABASE_URL = 'https://hcnlrldthpjzeehxilwg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjbmxybGR0aHBqemVlaHhpbHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMzg0MzYsImV4cCI6MjA2NzgxNDQzNn0.XaD7iXpsin7J22_HBpGJUs5IiPTpYLQupo7cYuYIN2A';
const TABLE = 'coffee_entries';

/* ========= INIT SUPABASE ========= */
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ========= STATE ========= */
let entries = [];
let activeType = 'single';
let dailyChart, typeChart;

/* ========= DATA OPS ========= */
async function fetchEntries() {
  const { data, error } = await supabase.from(TABLE).select('*').order('time', { ascending: false });
  if (error) return console.error(error);
  entries = data.map(e => ({ ...e, time: new Date(e.time) }));
  renderAll();
}

async function addEntry(user, type) {
  const { error } = await supabase.from(TABLE).insert({ user, type });
  if (error) return console.error(error);
  // Supabase real-time will update
}

async function removeEntry(id) {
  const { error } = await supabase.from(TABLE).delete().eq('id', id);
  if (error) console.error(error);
}

/* ========= REAL-TIME SUB ========= */
supabase
  .channel('coffee-rt')
  .on('postgres_changes', { event: '*', schema: 'public', table: TABLE }, payload => {
    fetchEntries();
  })
  .subscribe();

/* ========= RENDER HELPERS ========= */
const DAY_MS = 24 * 60 * 60 * 1000;
function startOfDay(d = new Date()) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function startOfYear(d = new Date()) { return new Date(d.getFullYear(), 0, 1); }
function since(date) { return entries.filter(e => e.time >= date); }

/* ========= RENDER QUICK INFO ========= */
function renderLastCoffee() {
  const card = document.getElementById('lastCoffeeCard');
  if (!entries.length) { card.innerHTML = '<span class="text-gray-500">Nessun caffè registrato.</span>'; return; }
  const last = entries[0];
  card.innerHTML = `
    <h3 class="text-lg mb-1 uppercase tracking-wide">Ultimo caffè</h3>
    <div class="text-3xl font-bold mb-1">${last.type}</div>
    <div class="text-sm text-gray-600">${last.user} — ${last.time.toLocaleString('it-IT')}</div>
  `;
}

/* ========= RENDER STATS ========= */
function renderStats() {
  const now = new Date();
  const periods = [
    { label: 'Oggi', since: startOfDay(now) },
    { label: 'Ultimi 7 giorni', since: new Date(now - 7 * DAY_MS) },
    { label: 'YTD', since: startOfYear(now) },
  ];
  const grid = document.getElementById('statsGrid');
  grid.innerHTML = '';
  periods.forEach(p => {
    const counts = since(p.since).reduce((obj, e) => {
      obj[e.user] = (obj[e.user] || 0) + 1;
      return obj;
    }, {});
    const total = Object.values(counts).reduce((a, b) => a + b, 0);
    const usersHTML = ['Michele', 'Martina']
      .map(u => `<span class="block">${u}: ${counts[u] || 0}</span>`)
      .join('');
    const card = document.createElement('div');
    card.className = 'p-4 rounded-2xl shadow-lg bg-white border border-gray-200 hover:shadow-xl transition';
    card.innerHTML = `
      <h3 class="text-lg mb-2 uppercase tracking-wide">${p.label}</h3>
      <div class="text-4xl font-bold mb-1">${total}</div>
      <div class="text-xs text-gray-500 leading-tight">${usersHTML}</div>
    `;
    grid.appendChild(card);
  });
}

/* ========= RENDER CHARTS ========= */
function renderCharts() {
  // Destroy existing charts to avoid duplicate canvas context
  dailyChart?.destroy();
  typeChart?.destroy();

  // ----- Daily line chart (last 30d) -----
  const today = startOfDay();
  const labels = Array.from({ length: 30 }, (_, i) => {
    const d = new Date(today - (29 - i) * DAY_MS);
    return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
  });
  const counts = labels.map((_, i) => {
    const dayStart = new Date(today - (29 - i) * DAY_MS);
    const dayEnd = new Date(dayStart.getTime() + DAY_MS);
    return entries.filter(e => e.time >= dayStart && e.time < dayEnd).length;
  });
  dailyChart = new Chart(document.getElementById('dailyChart'), {
    type: 'line',
    data: { labels, datasets: [{ data: counts, fill: false, tension: 0.3 }] },
    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  // ----- Type distribution pie (last 7d) -----
  const last7 = since(new Date(Date.now() - 7 * DAY_MS));
  const typeCounts = last7.reduce((obj, e) => {
    obj[e.type] = (obj[e.type] || 0) + 1;
    return obj;
  }, {});
  typeChart = new Chart(document.getElementById('typeChart'), {
    type: 'pie',
    data: {
      labels: Object.keys(typeCounts),
      datasets: [{ data: Object.values(typeCounts) }]
    },
    options: { plugins: { legend: { position: 'bottom' } } }
  });
}

/* ========= RENDER HISTORY ========= */
function renderHistory() {
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = '';
  entries.forEach(e => {
    const tr = document.createElement('tr');
    tr.className = 'border-b border-gray-200 hover:bg-gray-100';
    tr.innerHTML = `
      <td class="p-2">${e.time.toLocaleString('it-IT')}</td>
      <td class="p-2">${e.user}</td>
      <td class="p-2 capitalize">${e.type}</td>
      <td class="p-2"><button class="text-red-600 hover:underline" data-id="${e.id}">✕</button></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-id]').forEach(btn => {
    btn.addEventListener('click', () => removeEntry(btn.dataset.id));
  });
}

/* ========= RENDER ALL ========= */
function renderAll() {
  renderLastCoffee();
  renderStats();
  renderCharts();
  renderHistory();
}

/* ========= EVENTS ========= */
// Type selector buttons
const typeButtons = document.querySelectorAll('.btn-type');
typeButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    typeButtons.forEach(b => b.classList.remove('bg-black', 'text-white'));
    btn.classList.add('bg-black', 'text-white');
    activeType = btn.dataset.type;
  });
});

document.getElementById('addBtn').addEventListener('click', () => {
  const user = document.getElementById('user').value;
  addEntry(user, activeType);
});

/* ========= FIRST LOAD ========= */
fetchEntries();
</script>
</body>
</html>
